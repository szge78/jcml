{
  "steps": [
    {
      "name": "PreloadAllAgents",
      "className": "sk.concentra.jcml.pipeline.actions.EntityPreloadAction",
      "enabled": true,
      "params": {
        "entityClassName": "sk.concentra.jcml.persistence.Agent",
        "repositoryClassName": "sk.concentra.jcml.persistence.AgentRepository",
        "sessionContextKey": "agents"
      }
    },
    {
      "name": "PreloadAllAgentTeams",
      "className": "sk.concentra.jcml.pipeline.actions.EntityPreloadAction",
      "enabled": true,
      "params": {
        "entityClassName": "sk.concentra.jcml.persistence.AgentTeam",
        "repositoryClassName": "sk.concentra.jcml.persistence.AgentTeamRepository",
        "sessionContextKey": "agentTeams"
      }
    },
    {
      "name": "PreloadAllAttributes",
      "className": "sk.concentra.jcml.pipeline.actions.EntityPreloadAction",
      "enabled": true,
      "params": {
        "entityClassName": "sk.concentra.jcml.persistence.Attribute",
        "repositoryClassName": "sk.concentra.jcml.persistence.AttributeRepository",
        "sessionContextKey": "attributes"
      }
    },
    {
      "name": "PreloadAllSkillGroups",
      "className": "sk.concentra.jcml.pipeline.actions.EntityPreloadAction",
      "enabled": true,
      "params": {
        "entityClassName": "sk.concentra.jcml.persistence.SkillGroup",
        "repositoryClassName": "sk.concentra.jcml.persistence.SkillGroupRepository",
        "sessionContextKey": "skillGroups"
      }
    },
    {
      "name": "PreloadAllPrecisionQueues",
      "className": "sk.concentra.jcml.pipeline.actions.EntityPreloadAction",
      "enabled": true,
      "params": {
        "entityClassName": "sk.concentra.jcml.persistence.PrecisionQueue",
        "repositoryClassName": "sk.concentra.jcml.persistence.PrecisionQueueRepository",
        "sessionContextKey": "precisionQueues"
      }
    },
    {
      "name": "PreloadAllCampaigns",
      "className": "sk.concentra.jcml.pipeline.actions.EntityPreloadAction",
      "enabled": true,
      "params": {
        "entityClassName": "sk.concentra.jcml.persistence.Campaign",
        "repositoryClassName": "sk.concentra.jcml.persistence.CampaignRepository",
        "sessionContextKey": "campaigns"
      }
    },
    {
      "name": "PreloadAllDialingModes",
      "className": "sk.concentra.jcml.pipeline.actions.EntityPreloadAction",
      "enabled": true,
      "params": {
        "entityClassName": "sk.concentra.jcml.persistence.DialingMode",
        "repositoryClassName": "sk.concentra.jcml.persistence.DialingModeRepository",
        "sessionContextKey": "dialingModes"
      }
    },
    {
      "name": "RunNicePrecisionQueueTermsPreload",
      "className": "sk.concentra.jcml.pipeline.actions.NativeSqlPreloadAction",
      "enabled": true,
      "params": {
        "sessionContextKey": "nicePrecisionQueueTerms",
        "nativeSql": "SELECT pqt.PrecisionQueueTermID,  pqt.PrecisionQueueStepID, pqt.PrecisionQueueID, pqt.AttributeID, pqt.AttributeSetID, pqt.TermOrder, pqt.ParenCount, pqt.TermRelation, pqt.AttributeRelation, pqt.Value1, pqt.Value2, pqs.StepOrder, pqs.WaitTime, pqs.ConsiderIf, pqs.NextStep, pqs.Description, attr.EnterpriseName, attr.AttributeDataType, attr.MinimumValue, attr.MaximumValue, attr.DefaultValue, attr.AppearsOnDesktop, attr.SettableByAgent, attr.Description, attr.ChangeStamp, attr.Deleted, attr.DepartmentID, attr.DateTimeStamp FROM Precision_Queue_Term pqt LEFT OUTER JOIN Precision_Queue_Step pqs ON pqt.PrecisionQueueStepID = pqs.PrecisionQueueStepID LEFT OUTER JOIN Attribute attr ON pqt.AttributeID = attr.AttributeID",
        "idColumn": "PrecisionQueueTermID"
      }
    },
    {
      "name": "DebugContextState",
      "description": "Dumps the keys and sizes of the Session Context to the logs to verify preloading. Runs exactly once per session.",
      "className": "sk.concentra.jcml.pipeline.actions.ContextDumpAction",
      "enabled": true,
      "params": {
        "label": "POST-PRELOAD SNAPSHOT",
        "dumpGlobal": false,
        "dumpSession": true,
        "keysOnly": true
      }
    },
    {
      "name": "ExtractCmlHeaderInfo",
      "enabled": true,
      "description": "Extracts cmlId from _header[1] and machineName, pid, processName, userDomain, userName into a map, stored in session context under key cml_<cmlId>",
      "className": "sk.concentra.jcml.pipeline.actions.CmlHeaderExtractorAction",
      "params": {
        "filterField": "_messageType",
        "filterValue": "ADD",
        "headerKey": "_header",
        "keyPrefix": "cml_",
        "cmlId": {
          "lookupIndex": 1,
          "targetKey": "cmlId"
        },
        "fields": [
          {
            "lookupKey": "machineName",
            "targetKey": "machineName",
            "type": "String"
          },
          {
            "lookupKey": "pid",
            "targetKey": "pid",
            "type": "Integer"
          },
          {
            "lookupKey": "processName",
            "targetKey": "processName",
            "type": "String"
          },
          {
            "lookupKey": "userDomain",
            "targetKey": "userDomain",
            "type": "String"
          },
          {
            "lookupKey": "userName",
            "targetKey": "userName",
            "type": "String"
          }
        ]
      }
    },
    {
      "name": "UnwrapAllArrays",
      "className": "sk.concentra.jcml.pipeline.actions.ArrayUnwrapAction",
      "enabled": true,
      "params": {
        "arraysToUnwrap": {
          "ADD__AGENT":                   ["addAgentItems"],
          "ADD__PERSON":                  ["addPersonItems"],
          "ADD__SKILL_TARGET":            ["addSkillTargetItems"],
          "ADD__AGENT_TEAM":              ["addAgentTeamItems"],
          "ADD__AGENT_TEAM_MEMBER":       ["addAgentTeamMemberItems"],
          "DELETE__AGENT_TEAM_MEMBER":    ["deleteAgentTeamMemberItems"],
          "ADD__AGENT_ATTRIBUTE":         ["addAgentAttributeItems"],
          "DELETE__AGENT_ATTRIBUTE":      ["deleteAgentAttributeItems"],
          "ADD__SKILL_GROUP_MEMBER":      ["addSkillGroupMemberItems"],
          "DELETE__SKILL_GROUP_MEMBER":   ["deleteSkillGroupMemberItems"],
          "UPDATE__SKILL_GROUP_MEMBER":   ["updateSkillGroupMemberItems"],
          "ADD__PRECISION_QUEUE_TERM":    ["addPrecisionQueueTermItems"],
          "DELETE__PRECISION_QUEUE_TERM": ["deletePrecisionQueueTermItems"],
          "ADD__PRECISION_QUEUE_STEP":    ["addPrecisionQueueStepItems"],
          "DELETE__PRECISION_QUEUE_STEP": ["deletePrecisionQueueStepItems"]
        },
        "messageTypeField": "_messageType",
        "fieldsToCopy": ["_header", "_dbMetadata", "_messageType"],
        "indexFieldName": "_arrayIdx",
        "arrayKeyFieldName": "_sourceArrayKeyFieldName"
      }
    },
    {
      "name": "ConvertTimestamp",
      "enabled": true,
      "description": "Convert DateTimeStamp to Unix timestamp (output: unixTimestamp) and also add human-readable timestamp (output: humanReadableTimestamp) in the zone specified in params.",
      "className": "sk.concentra.jcml.pipeline.actions.TimestampConverterAction",
      "params": {
        "inputFieldNames": ["DateTimeStamp", "dateTimeStamp"],
        "zoneIdForHumanReadableTimestamp": "Europe/Budapest",
        "unixTimestampFieldName": "_epochMillis",
        "humanReadableTimestampFieldName": "_localTime"
      }
    },
    {
      "name": "EnrichCmlDataWithMachineAndUserInformation",
      "description": "Enriches the CML data with machine and user information from the session context.",
      "className": "sk.concentra.jcml.pipeline.actions.SessionEnrichAction",
      "enabled": true,
      "params": {
        "prefix": "cml_",
        "idExpression": "_header[1]",
        "idType": "integer",
        "includeFields": [
          "processName",
          "userDomain",
          "userName",
          "machineName"
        ],
        "fieldMappings": {
          "processName": "_processName",
          "userDomain": "_userDomain",
          "userName": "_userName",
          "machineName": "_machineName"
        }
      }
    },
    {
      "name": "FilterCmlTransactions",
      "description": "Drops all items belonging to a CML transaction if any item in that transaction matches a configured field==value condition (e.g. service accounts or unwanted message types). Must run after EnrichCmlDataWithMachineAndUserInformation.",
      "className": "sk.concentra.jcml.pipeline.actions.CmlTransactionFilterAction",
      "enabled": true,
      "params": {
        "conditions": [
          "_messageType==UPDATE__SMART_LICENSE_INFO",
          "_messageType==UPDATE__SMART_LICENSE_ENTITLEMENTS"
        ]
      }
    },
    {
      "name": "ApplyTemplates",
      "className": "sk.concentra.jcml.pipeline.actions.BatchTemplateAction",
      "enabled": true,
      "params": {
        "rules": [
          {
            "condition": "_messageType.in('FIRST')",
            "templates": {
              "_full_description": "Začátek transakce cmlId: {{item._header[1]}} dt: {{item._dbMetadata.dateTime}}"
            }
          },
          {
            "condition": "_messageType.in('LAST')",
            "templates": {
              "_full_description": "Ukončení transakce cmlId: {{item._header[1]}} dt: {{item._dbMetadata.dateTime}}"
            }
          },
          {
            "condition": "_messageType.in('ADD')",
            "templates": {
              "_full_description": "Metadata cmlId: {{item._header[1]}} RK: {{item._dbMetadata.recoveryKey}}"
            }
          },
           {
            "condition": "_messageType.in('UPDATE__PRECISION_QUEUE')",
            "templates": {
              "_full_description": "PQ {{eval(concat('session.precisionQueues.', item.precisionQueueID)).enterpriseName}} ({{item.precisionQueueID}})"
            }
          },
          {
            "condition": "_messageType.in('ADD__PRECISION_QUEUE_TERM')",
            "templates": {
              "_full_description": "PQ {{eval(concat('session.precisionQueues.', item.precisionQueueID)).enterpriseName}} termOrder: {{item.termOrder}} precisionQueueTermID: {{item.precisionQueueTermID}} stepOrder: {{eval(concat('session.nicePrecisionQueueTerms.', item.precisionQueueTermID)).StepOrder}} waitTime: {{eval(concat('session.nicePrecisionQueueTerms.', item.precisionQueueTermID)).PrecisionQueueTermID}} attr: {{eval(concat('session.nicePrecisionQueueTerms.', item.precisionQueueTermID)).EnterpriseName}}"
            }
          },
          {
            "condition": "_messageType.in('DELETE__PRECISION_QUEUE_TERM', 'DELETE__PRECISION_QUEUE_STEP')",
            "templates": {
              "_full_description": "PQ {{eval(concat('session.precisionQueues.', item.precisionQueueID)).enterpriseName}} ({{item.precisionQueueID}})"
            }
          },
          {
            "condition": "_messageType.in('UPDATE__CAMPAIGN')",
            "templates": {
              "_full_description": "Kampaň {{eval(concat('session.campaigns.', item.campaignID)).campaignName}}"
            }
          },
          {
            "condition": "_messageType.in('UPDATE__PERSON')",
            "templates": {
              "_full_description": "Agent {{item.firstName}} {{item.lastName}} ({{item.loginName}})"
            }
          },
          {
            "condition": "_messageType.in('UPDATE__AGENT')",
            "templates": {
              "_full_description": "Agent {{item.enterpriseName}} [{{item.peripheralNumber}}]"
            }
          },
          {
            "condition": "_messageType.in('UPDATE__CAMPAIGN_SKILL_GROUP')",
            "templates": {
              "_full_description": "Kampaň {{eval(concat('session.campaigns.', item.campaignID)).campaignName}} ↦ M: {{eval(concat('session.dialingModes.', item.dialingMode)).dialingModeText}} RES%: {{item.reservationPercentage}}"
            }
          },
          {
            "condition": "_messageType.in('ADD__PRECISION_QUEUE_STEP')",
            "templates": {
              "_full_description": "PQ '{{eval(concat('session.precisionQueues.', item.precisionQueueID)).enterpriseName}}' ({{item.precisionQueueID}}) stepOrder: {{item.stepOrder}} nextStep: {{item.nextStep}} waitTime: {{item.waitTime}} considerIf: {{item.considerIf}}"
            }
          },
          {
            "condition": "_messageType.in('ADD__SKILL_GROUP_MEMBER')",
            "templates": {
              "_full_description": "Agent '{{eval(concat('session.agents.', item.agentSkillTargetID)).enterpriseName}}' ⊕SG: '{{eval(concat('session.skillGroups.', item.skillGroupSkillTargetID)).enterpriseName}}'"
            }
          },
          {
            "condition": "_messageType.in('DELETE__SKILL_GROUP_MEMBER')",
            "templates": {
              "_full_description": "Agent '{{eval(concat('session.agents.', item.agentSkillTargetID)).enterpriseName}}' ⊖SG: '{{eval(concat('session.skillGroups.', item.skillGroupSkillTargetID)).enterpriseName}}'"
            }
          },
          {
            "condition": "_messageType.in('DELETE__AGENT_TEAM_MEMBER','ADD__AGENT_TEAM_MEMBER')",
            "templates": {
              "_full_description": "Agent Team '{{eval(concat('session.agentTeams.', item.agentTeamID)).enterpriseName}}' -> Agent: '{{eval(concat('session.agents.', item.skillTargetID)).enterpriseName}}'"
            }
          },
          {
            "condition": "_messageType.in('DELETE__AGENT_ATTRIBUTE')",
            "templates": {
              "_full_description": "Agent '{{eval(concat('session.agents.', item.agentTeamID)).enterpriseName}}' ⊖ATTR: '{{eval(concat('session.attributes.', item.attributeID)).enterpriseName}}'"
            }
          },
          {
            "condition": "_messageType.in('UPDATE__AGENT_ATTRIBUTE')",
            "templates": {
              "_full_description": "Agent '{{eval(concat('session.agents.', item.skillTargetID)).enterpriseName}}' ↑ATTR: '{{eval(concat('session.attributes.', item.attributeID)).enterpriseName}}' hodnota: {{item.attributeValue}}"
            }
          }
        ]
      }
    },
    {
      "name": "FinalSortAction",
      "className": "sk.concentra.jcml.pipeline.actions.SortAction",
      "enabled": true,
      "params": {
        "sortKeys": [
          {
            "field":       "_dbMetadata.recoveryKey",
            "direction":   "asc",
            "nullsFirst":  true
          },
          {
            "field":       "_arrayIdx",
            "direction":   "asc",
            "nullsFirst":  true
          }
        ]
      }
    }
  ]
}